{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "InvestorDashboard",
  "description": "Schema for investor dashboard data. Follows atomic metric philosophy: only base, non-derivable data is stored. All KPIs are calculated on-demand via kpi-calculations.ts.",
  "type": "object",
  "properties": {
    "company_type": {
      "type": "string",
      "enum": ["public", "private"],
      "description": "Classification of the company"
    },
    "run_metadata": {
      "type": ["object", "null"],
      "description": "Immutable metadata for the dashboard run",
      "properties": {
        "run_id": { "type": ["string", "null"] },
        "entity": { "type": ["string", "null"] },
        "ticker": { "type": ["string", "null"] },
        "timestamp": { "type": ["string", "null"] },
        "owner": { "type": ["string", "null"] }
      }
    },
    "base_metrics": {
      "type": ["object", "null"],
      "description": "Atomic, non-derivable financial and operational metrics. All KPIs are calculated from these base values.",
      "properties": {
        "market_cap": { "type": ["number", "null"], "description": "Market capitalization in USD" },
        "stock_price": { "type": ["number", "null"], "description": "Current stock price" },
        "shares_outstanding": { "type": ["number", "null"], "description": "Total shares outstanding" },
        "total_debt": { "type": ["number", "null"], "description": "Total debt" },
        "preferred_stock": { "type": ["number", "null"], "description": "Preferred stock value" },
        "minority_interest": { "type": ["number", "null"], "description": "Minority interest" },
        "cash": { "type": ["number", "null"], "description": "Cash on hand" },
        "marketable_securities": { "type": ["number", "null"], "description": "Marketable securities" },
        "current_assets": { "type": ["number", "null"], "description": "Current assets" },
        "current_liabilities": { "type": ["number", "null"], "description": "Current liabilities" },
        "accounts_receivable": { "type": ["number", "null"], "description": "Accounts receivable" },
        "revenue": { "type": ["number", "null"], "description": "Revenue (quarterly)" },
        "revenue_prior": { "type": ["number", "null"], "description": "Prior period revenue (for growth calculation)" },
        "gross_profit": { "type": ["number", "null"], "description": "Gross profit" },
        "operating_income": { "type": ["number", "null"], "description": "Operating income" },
        "depreciation_amortization": { "type": ["number", "null"], "description": "Depreciation and amortization" },
        "interest_expense": { "type": ["number", "null"], "description": "Interest expense" },
        "revenue_ttm": { "type": ["number", "null"], "description": "Revenue (trailing twelve months)" },
        "ebitda_ttm": { "type": ["number", "null"], "description": "EBITDA (trailing twelve months)" },
        "gross_profit_ttm": { "type": ["number", "null"], "description": "Gross profit (TTM)" },
        "operating_income_ttm": { "type": ["number", "null"], "description": "Operating income (TTM)" },
        "ebitda_reported": { "type": ["number", "null"], "description": "Reported EBITDA" },
        "ebitda_proxy": { "type": ["number", "null"], "description": "Proxy EBITDA (Operating Income + D&A)" },
        "ebitda_availability": {
          "type": ["string", "null"],
          "enum": ["reported", "proxy", "not_applicable"],
          "description": "Source of EBITDA value"
        },
        "free_cash_flow": { "type": ["number", "null"], "description": "Free cash flow" },
        "net_burn": { "type": ["number", "null"], "description": "Net burn rate" },
        "headcount": { "type": ["number", "null"], "description": "Total headcount" },
        "rd_spend": { "type": ["number", "null"], "description": "R&D spending" },
        "sm_spend": { "type": ["number", "null"], "description": "Sales & marketing spending" },
        "sm_spend_prior": { "type": ["number", "null"], "description": "Prior period S&M spending" },
        "arr": { "type": ["number", "null"], "description": "Annual recurring revenue" },
        "arr_prior": { "type": ["number", "null"], "description": "Prior period ARR" },
        "new_arr": { "type": ["number", "null"], "description": "New ARR" },
        "expansion_arr": { "type": ["number", "null"], "description": "Expansion ARR" },
        "contraction_arr": { "type": ["number", "null"], "description": "Contraction ARR" },
        "churned_arr": { "type": ["number", "null"], "description": "Churned ARR" },
        "monthly_churn_percent": { "type": ["number", "null"], "description": "Monthly churn rate (%)" },
        "cac": { "type": ["number", "null"], "description": "Customer acquisition cost" },
        "ltv": { "type": ["number", "null"], "description": "Customer lifetime value" },
        "arpa": { "type": ["number", "null"], "description": "Average revenue per account" },
        "gross_margin_percent": { "type": ["number", "null"], "description": "Gross margin percentage" },
        "average_customer_lifespan_months": { "type": ["number", "null"], "description": "Average customer lifespan in months" },
        "customer_count": { "type": ["number", "null"], "description": "Total customer count" },
        "top_customer_revenue_percent": { "type": ["number", "null"], "description": "Revenue concentration: top customer %" },
        "top_3_customer_revenue_percent": { "type": ["number", "null"], "description": "Revenue concentration: top 3 customers %" },
        "top_10_customer_revenue_percent": { "type": ["number", "null"], "description": "Revenue concentration: top 10 customers %" },
        "top_supplier_spend_percent": { "type": ["number", "null"], "description": "Supplier concentration: top supplier %" },
        "top_5_supplier_spend_percent": { "type": ["number", "null"], "description": "Supplier concentration: top 5 suppliers %" }
      }
    },
    "time_series": {
      "type": ["object", "null"],
      "description": "Historical time series data for charting",
      "properties": {
        "stock_price": { "$comment": "See timeSeriesMetric structure" },
        "revenue": { "$comment": "See timeSeriesMetric structure" },
        "ebitda": { "$comment": "See timeSeriesMetric structure" },
        "volume": { "$comment": "See timeSeriesMetric structure" }
      },
      "additionalProperties": {
        "type": ["object", "null"],
        "properties": {
          "horizons": {
            "type": ["object", "null"],
            "properties": {
              "1D": { "$comment": "See horizonStats structure" },
              "1W": { "$comment": "See horizonStats structure" },
              "1M": { "$comment": "See horizonStats structure" },
              "1Y": { "$comment": "See horizonStats structure" },
              "5Y": { "$comment": "See horizonStats structure" },
              "10Y": { "$comment": "See horizonStats structure" }
            },
            "additionalProperties": {
              "type": ["object", "null"],
              "properties": {
                "quarters": {
                  "type": ["object", "null"],
                  "properties": {
                    "Q1": { "type": ["number", "null"] },
                    "Q2": { "type": ["number", "null"] },
                    "Q3": { "type": ["number", "null"] },
                    "Q4": { "type": ["number", "null"] }
                  }
                },
                "high": { "type": ["number", "null"] },
                "low": { "type": ["number", "null"] },
                "average": { "type": ["number", "null"] },
                "volatility": { "type": ["number", "null"] },
                "change_percent": { "type": ["number", "null"] }
              }
            }
          },
          "availability": { "type": ["string", "null"] },
          "unavailable_reason": { "type": ["string", "null"] },
          "confidence": { "type": ["number", "null"] },
          "data_quality": { "$comment": "See dataQuality structure" },
          "source": { "type": ["string", "null"] },
          "decision_context": { "$comment": "See decisionContext structure" }
        }
      }
    },
    "changes_since_last_run": {
      "type": ["array", "null"],
      "items": {
        "type": ["object", "null"],
        "properties": {
          "id": { "type": ["string", "null"] },
          "timestamp": { "type": ["string", "null"] },
          "category": { "type": ["string", "null"] },
          "title": { "type": ["string", "null"] },
          "description": { "type": ["string", "null"] },
          "source_url": { "type": ["string", "null"] },
          "thesis_pillar": { "type": ["string", "null"] },
          "so_what": { "type": ["string", "null"] },
          "action": { "type": ["string", "null"] }
        }
      }
    },
    "executive_summary": {
      "type": ["object", "null"],
      "properties": {
        "headline": { "type": ["string", "null"] },
        "key_facts": { "type": ["array", "null"], "items": { "type": "string" } },
        "implications": { "type": ["array", "null"], "items": { "type": "string" } },
        "key_risks": { "type": ["array", "null"], "items": { "type": "string" } },
        "thesis_status": { "type": ["string", "null"], "description": "intact | challenged | broken" }
      }
    },
    "valuation": {
      "type": ["object", "null"],
      "description": "Valuation data from multiple methodologies. Implied upside/midpoint are CALCULATED in kpi-calculations.ts, not stored.",
      "properties": {
        "valuation_range_low": { "type": ["number", "null"] },
        "valuation_range_high": { "type": ["number", "null"] },
        "valuation_range_midpoint": { "type": ["number", "null"] },
        "why_range_exists": { "type": ["string", "null"] },
        "dcf": {
          "type": ["object", "null"],
          "properties": {
            "terminal_growth_rate": { "$comment": "atomicValue: value + source_reference" },
            "wacc": { "$comment": "atomicValue: value + source_reference" },
            "implied_value": { "$comment": "atomicValue: value + source_reference" },
            "implied_value_per_share": { "$comment": "atomicValue: value + source_reference" },
            "source": { "type": ["string", "null"] },
            "source_reference": { "$comment": "See sourceReference structure" },
            "methodology": { "type": ["string", "null"] }
          }
        },
        "trading_comps": {
          "type": ["object", "null"],
          "properties": {
            "implied_value_range_low": { "$comment": "atomicValue" },
            "implied_value_range_high": { "$comment": "atomicValue" },
            "peer_set": { "type": ["array", "null"], "items": { "type": "string" } },
            "multiple_used": { "type": ["string", "null"] },
            "source": { "type": ["string", "null"] },
            "source_reference": { "$comment": "See sourceReference structure" },
            "confidence": { "$comment": "See dataQuality structure" }
          }
        },
        "precedent_transactions": {
          "type": ["object", "null"],
          "properties": {
            "implied_value_range_low": { "$comment": "atomicValue" },
            "implied_value_range_high": { "$comment": "atomicValue" },
            "transactions": {
              "type": ["array", "null"],
              "items": {
                "type": "object",
                "properties": {
                  "name": { "type": ["string", "null"] },
                  "date": { "type": ["string", "null"] },
                  "multiple": { "type": ["number", "null"] }
                }
              }
            },
            "source": { "type": ["string", "null"] },
            "source_reference": { "$comment": "See sourceReference structure" },
            "confidence": { "$comment": "See dataQuality structure" }
          }
        }
      }
    },
    "hypotheses": {
      "type": ["array", "null"],
      "description": "Forward-looking claims with falsification criteria",
      "items": {
        "type": ["object", "null"],
        "properties": {
          "id": { "type": ["string", "null"] },
          "type": { "type": ["string", "null"] },
          "title": { "type": ["string", "null"] },
          "summary": { "type": ["string", "null"] },
          "details": { "type": ["string", "null"] },
          "assumptions": { "type": ["array", "null"], "items": { "type": "string" } },
          "falsification_criteria": { "type": ["array", "null"], "items": { "type": "string" } },
          "confidence_band": { "type": ["string", "null"], "description": "Low | Medium | High" },
          "source": { "type": ["string", "null"] },
          "generated_at": { "type": ["string", "null"] },
          "horizon_relevance": { "type": ["array", "null"], "items": { "type": "string" } },
          "impact_score": { "type": ["number", "null"] },
          "action_required": { "type": ["boolean", "null"] }
        }
      }
    },
    "ai_insights": {
      "type": ["array", "null"],
      "description": "AI-generated insights (same structure as hypotheses)"
    },
    "events": {
      "type": ["array", "null"],
      "items": {
        "type": ["object", "null"],
        "properties": {
          "id": { "type": ["string", "null"] },
          "date": { "type": ["string", "null"] },
          "type": { "type": ["string", "null"] },
          "title": { "type": ["string", "null"] },
          "description": { "type": ["string", "null"] },
          "impact": { "type": ["string", "null"] },
          "source_url": { "type": ["string", "null"] }
        }
      }
    },
    "scenarios": {
      "type": ["object", "null"],
      "description": "Base, downside, and upside scenarios with probability weights",
      "properties": {
        "base": { "$comment": "See singleScenario structure" },
        "downside": { "$comment": "See singleScenario structure" },
        "upside": { "$comment": "See singleScenario structure" }
      },
      "additionalProperties": {
        "type": ["object", "null"],
        "properties": {
          "probability": { "type": ["number", "null"], "description": "Probability weight (0-1)" },
          "assumptions": {
            "type": ["array", "null"],
            "items": {
              "type": ["object", "null"],
              "properties": {
                "key": { "type": ["string", "null"] },
                "value": { "type": ["string", "null"] },
                "source": { "type": ["string", "null"] },
                "source_reference": { "$comment": "See sourceReference structure" }
              }
            }
          },
          "drivers": {
            "type": ["array", "null"],
            "items": {
              "type": ["object", "null"],
              "properties": {
                "name": { "type": ["string", "null"] },
                "category": { "type": ["string", "null"] },
                "value": { "type": ["string", "null"] },
                "unit": { "type": ["string", "null"] },
                "source": { "type": ["string", "null"] },
                "source_reference": { "$comment": "See sourceReference structure" }
              }
            }
          },
          "outputs": {
            "type": ["object", "null"],
            "properties": {
              "revenue": { "$comment": "See scenarioOutputMetric structure" },
              "ebitda": { "$comment": "See scenarioOutputMetric structure" },
              "valuation": { "$comment": "See scenarioOutputMetric structure" }
            },
            "additionalProperties": {
              "type": ["object", "null"],
              "properties": {
                "value": { "type": ["number", "string", "null"] },
                "formatted": { "type": ["string", "null"] },
                "source": { "type": ["string", "null"] },
                "formula": { "type": ["string", "null"], "description": "Formula for scenario outputs only (drivers to output)" },
                "formula_inputs": {
                  "type": ["array", "null"],
                  "items": {
                    "type": ["object", "null"],
                    "properties": {
                      "name": { "type": ["string", "null"] },
                      "value": { "type": ["number", "string", "null"] },
                      "source": { "type": ["string", "null"] },
                      "source_reference": { "$comment": "See sourceReference structure" }
                    }
                  }
                },
                "period": { "type": ["string", "null"] },
                "source_reference": { "$comment": "See sourceReference structure" }
              }
            }
          }
        }
      }
    },
    "risks": {
      "type": ["object", "null"],
      "description": "Risks categorized by type",
      "properties": {
        "regulatory": { "type": "array", "items": { "$comment": "See riskItem structure" } },
        "market": { "type": "array", "items": { "$comment": "See riskItem structure" } },
        "operational": { "type": "array", "items": { "$comment": "See riskItem structure" } },
        "cybersecurity": { "type": "array", "items": { "$comment": "See riskItem structure" } },
        "financial": { "type": "array", "items": { "$comment": "See riskItem structure" } },
        "strategic": { "type": "array", "items": { "$comment": "See riskItem structure" } }
      },
      "additionalProperties": {
        "type": "array",
        "items": {
          "type": ["object", "null"],
          "properties": {
            "id": { "type": ["string", "null"] },
            "title": { "type": ["string", "null"] },
            "description": { "type": ["string", "null"] },
            "severity": { "type": ["string", "null"] },
            "probability": { "type": ["number", "null"] },
            "trigger": { "type": ["string", "null"] },
            "trigger_metric": { "type": ["string", "null"] },
            "mitigation": { "type": ["string", "null"] },
            "mitigation_action": { "type": ["string", "null"] },
            "status": { "type": ["string", "null"], "enum": ["Active", "Monitoring", "Resolved"] },
            "source": { "type": ["string", "null"] },
            "source_reference": { "$comment": "See sourceReference structure" }
          }
        }
      }
    },
    "path_indicators": {
      "type": ["array", "null"],
      "description": "Measurable indicators tracking thesis progress",
      "items": {
        "type": ["object", "null"],
        "properties": {
          "label": { "type": ["string", "null"] },
          "value": { "type": ["string", "null"] },
          "status": { "type": ["string", "null"] },
          "next_check": { "type": ["string", "null"] }
        }
      }
    },
    "position_sizing": {
      "type": ["object", "null"],
      "properties": {
        "current_percent": { "type": ["number", "null"] },
        "max_percent": { "type": ["number", "null"] },
        "target_low": { "type": ["number", "null"] },
        "target_high": { "type": ["number", "null"] }
      }
    },
    "variant_view": {
      "type": ["object", "null"],
      "properties": {
        "summary": { "type": ["string", "null"] },
        "sensitivity": {
          "type": ["array", "null"],
          "items": {
            "type": "object",
            "properties": {
              "label": { "type": ["string", "null"] },
              "impact": { "type": ["string", "null"] }
            }
          }
        }
      }
    },
    "kill_switch": {
      "type": ["object", "null"],
      "properties": {
        "conditions": { "type": ["array", "null"], "items": { "type": "string" } }
      }
    },
    "net_cash_or_debt": { "$comment": "See metric structure" },
    "buyback_capacity": { "$comment": "See metric structure" },
    "sbc_percent_revenue": { "$comment": "See metric structure" },
    "share_count_trend": { "$comment": "See metric structure" },
    "segments": {
      "type": ["array", "null"],
      "items": {
        "type": "object",
        "properties": {
          "name": { "type": ["string", "null"] },
          "revenue": { "$comment": "See metric structure" },
          "growth": { "$comment": "See metric structure" },
          "margin": { "$comment": "See metric structure" }
        }
      }
    },
    "guidance_bridge": {
      "type": ["object", "null"],
      "description": "Guidance vs consensus tracking. gap_percent is CALCULATED in kpi-calculations.ts.",
      "properties": {
        "low": { "$comment": "atomicValue: value + source_reference" },
        "high": { "$comment": "atomicValue: value + source_reference" },
        "current_consensus": { "$comment": "atomicValue: value + source_reference" },
        "gap_percent": { "$comment": "atomicValue: value + source_reference (stored for display, formula in kpi-calculations)" },
        "source": { "type": ["string", "null"] },
        "source_reference": { "$comment": "See sourceReference structure" },
        "last_updated": { "type": ["string", "null"] }
      }
    },
    "revisions_momentum": {
      "type": ["object", "null"],
      "properties": {
        "direction": { "type": ["string", "null"] },
        "magnitude": { "$comment": "atomicValue: value + source_reference" },
        "trend": { "type": ["string", "null"] },
        "source": { "type": ["string", "null"] },
        "source_reference": { "$comment": "See sourceReference structure" },
        "last_updated": { "type": ["string", "null"] }
      }
    },
    "sources": {
      "type": ["array", "null"],
      "description": "Data sources with refresh status and priority",
      "items": {
        "type": "object",
        "properties": {
          "name": { "type": "string" },
          "type": { "type": "string", "enum": ["primary", "secondary"] },
          "last_refresh": { "type": "string" },
          "refresh_frequency": { "type": "string", "enum": ["realtime", "hourly", "daily", "weekly", "quarterly", "manual"] },
          "status": { "type": "string", "enum": ["connected", "stale", "error", "pending"] },
          "priority": { "type": "number", "description": "Lower = higher priority" },
          "url": { "type": "string" },
          "metrics_covered": { "type": "array", "items": { "type": "string" } },
          "next_refresh": { "type": "string" }
        },
        "required": ["name", "type", "last_refresh"]
      }
    },
    "unit_economics": {
      "type": ["object", "null"],
      "description": "Unit economics with investor context. LTV/CAC ratio and payback are CALCULATED in kpi-calculations.ts.",
      "properties": {
        "cac": { "$comment": "atomicValue: value + source_reference" },
        "ltv": { "$comment": "atomicValue: value + source_reference" },
        "ltv_cac_ratio": { "$comment": "atomicValue: value + source_reference (can be stored or calculated)" },
        "payback_period_months": { "$comment": "atomicValue: value + source_reference (can be stored or calculated)" },
        "investor_context": {
          "type": ["object", "null"],
          "properties": {
            "ltv_cac_interpretation": { "type": ["string", "null"] },
            "benchmark_comparison": { "type": ["string", "null"] },
            "trend_analysis": { "type": ["string", "null"] },
            "risk_factors": { "type": ["array", "null"], "items": { "type": "string" } },
            "action_implications": { "type": ["string", "null"] }
          }
        },
        "source": { "type": ["string", "null"] },
        "source_reference": { "$comment": "See sourceReference structure" }
      }
    },
    "run_data_quality": { "$comment": "See dataQuality structure" }
  },
  "required": ["company_type"],
  "definitions": {
    "sourceReference": {
      "type": ["object", "null"],
      "description": "Reference to original data source - this IS stored in schema (cannot be derived)",
      "properties": {
        "url": { "type": ["string", "null"], "description": "URL to source document" },
        "document_type": { "type": ["string", "null"], "description": "e.g., 10-K, 10-Q, 8-K, Press Release" },
        "excerpt": { "type": ["string", "null"], "description": "Relevant excerpt from source" },
        "accessed_at": { "type": ["string", "null"], "description": "ISO timestamp of when source was accessed" }
      }
    },
    "dataQuality": {
      "type": ["object", "null"],
      "description": "Three-part data quality metric",
      "properties": {
        "coverage": { "type": ["number", "null"], "description": "% of exhibits populated (0-100)" },
        "auditability": { "type": ["number", "null"], "description": "% source-linked (0-100)" },
        "freshness_days": { "type": ["number", "null"], "description": "Age in days" }
      }
    },
    "decisionContext": {
      "type": ["object", "null"],
      "description": "Decision layer for actionable confidence signals",
      "properties": {
        "confidence_level": { "type": ["string", "null"], "description": "high | medium | low" },
        "sufficiency_status": { "type": ["string", "null"], "description": "sufficient | insufficient" },
        "knowns": { "type": ["array", "null"], "items": { "type": "string" } },
        "unknowns": { "type": ["array", "null"], "items": { "type": "string" } },
        "what_changes_conclusion": { "type": ["array", "null"], "items": { "type": "string" } }
      }
    },
    "metricDefinition": {
      "type": ["object", "null"],
      "description": "Metadata for headline metrics (Definition Pill)",
      "properties": {
        "metric_name": { "type": ["string", "null"] },
        "period": { "type": ["string", "null"], "description": "e.g., Q3 2024, TTM" },
        "basis": { "type": ["string", "null"], "description": "GAAP | Non-GAAP" },
        "currency": { "type": ["string", "null"] },
        "unit": { "type": ["string", "null"] }
      }
    },
    "atomicValue": {
      "type": ["object", "null"],
      "description": "Atomic value with source reference. NO formula stored - formulas live in kpi-calculations.ts",
      "properties": {
        "value": { "type": ["number", "null"] },
        "formatted": { "type": ["string", "null"] },
        "source": { "type": ["string", "null"] },
        "source_reference": { "$comment": "See sourceReference structure" }
      }
    },
    "metric": {
      "type": ["object", "null"],
      "description": "Full metric with all metadata",
      "properties": {
        "value": { "type": ["number", "string", "null"] },
        "formatted": { "type": ["string", "null"] },
        "unit": { "type": ["string", "null"] },
        "source": { "type": ["string", "null"] },
        "source_reference": { "$comment": "See sourceReference structure" },
        "tie_out_status": { "type": ["string", "null"] },
        "last_updated": { "type": ["string", "null"] },
        "availability": { "type": ["string", "null"] },
        "unavailable_reason": { "type": ["string", "null"] },
        "confidence": { "type": ["number", "null"], "description": "Legacy - use data_quality instead" },
        "data_quality": { "$comment": "See dataQuality structure" },
        "decision_context": { "$comment": "See decisionContext structure" },
        "definition": { "$comment": "See metricDefinition structure" }
      }
    }
  }
}
